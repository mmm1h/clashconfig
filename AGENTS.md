<!-- OPENSPEC:START -->
# OpenSpec Instructions

These instructions are for AI assistants working in this project.

Always open `@/openspec/AGENTS.md` when the request:
- Mentions planning or proposals (words like proposal, spec, change, plan)
- Introduces new capabilities, breaking changes, architecture shifts, or big performance/security work
- Sounds ambiguous and you need the authoritative spec before coding

Use `@/openspec/AGENTS.md` to learn:
- How to create and apply change proposals
- Spec format and conventions
- Project structure and guidelines

Keep this managed block so 'openspec update' can refresh the instructions.

<!-- OPENSPEC:END -->

# Agent Guide

## Project summary
- This repo stores Clash/Mihomo configuration, custom rule lists, and generated merged lists.
- It also includes Quantumult X config, PaoPaoDNS force-TTL rules, helper scripts, and ImmortalWrt build notes.

## Repository layout
- `mihomo.yaml`: primary Mihomo/Clash config (providers, DNS, proxy groups, rule providers, rules).
- `mihomo.js`: JS config generator; keep group/rule names aligned with `mihomo.yaml`.
- `QuantumultX.conf`: Quantumult X policy/rule config and remote lists.
- `rules/`: custom Clash rule lists and CN IP list (`rules/README.md` documents the set).
- `*Merged.list`: generated merged rule lists with source headers.
- `force_ttl_rules.txt`: generated PaoPaoDNS rules.
- `scripts/`: helper scripts for rule generation and OpenWrt automation.
- `ImmortalWrt构建/`: ImmortalWrt build notes and helper files (see its README).
- `alc4.ini`: ACL4SSR config snapshot/reference (treat as vendor data).

## Configuration linkage
- `mihomo.yaml` and `mihomo.js` must reference the same proxy groups and rule targets.
- Group names often include emoji/CJK characters; copy/paste exact strings to avoid subtle mismatches.
- `QuantumultX.conf` shares policy group names with Mihomo; keep overlaps consistent.
- Preserve placeholder values unless explicitly updating:
  - `__MEIYING_URL__`, `__YUNDONG_URL__` (subscription URLs)
  - `__QX_MITM_P12__` (Quantumult X MITM cert placeholder)

## Rule list conventions
- One rule per line, no empty lines, no trailing spaces.
- Use Clash classical keywords: `DOMAIN`, `DOMAIN-SUFFIX`, `DOMAIN-KEYWORD`, `IP-CIDR`, `IP-CIDR6` (optional `,no-resolve`).
- `rules/CN.txt` is the CN IP list (used for iKuai and for direct routing updates).
- `rules/Direct.list` contains an auto-managed block delimited by:
  - `# --- CN.txt START (auto) ---`
  - `# --- CN.txt END (auto) ---`
  Do not edit inside this block manually.

## Generated artifacts (do not hand-edit)
- `*Merged.list`: merged outputs with source headers; regenerate from the listed sources.
- `force_ttl_rules.txt`: generated by `scripts/update_dns.py`.
- Provider cache files under `./providers/` are runtime outputs and not tracked.

## Scripts
- `scripts/update_direct_from_cn.py`
  - Reads `rules/CN.txt`, updates the auto-managed CN block in `rules/Direct.list`.
- `scripts/update_dns.py`
  - Generates `force_ttl_rules.txt` from multiple sources.
  - Requires Python 3, `requests`, and network access.
- `scripts/update_dns_rules.sh`
  - Server-side updater to download latest `force_ttl_rules.txt` and optionally restart PaoPaoDNS.
  - Configure `REMOTE_URL`, `LOCAL_FILE`, and `RESTART_CMD` before use.
- `scripts/update_zashboard.sh`
  - OpenWrt helper to update OpenClash Zashboard UI; can install a cron job.

## Update flows
- Add/update custom rules:
  1) Edit the appropriate file in `rules/`.
  2) Ensure the list is referenced in `mihomo.yaml` and/or `mihomo.js`.
  3) If relevant for Quantumult X, update `QuantumultX.conf` remote list entries.
- Update CN IPs:
  1) Edit `rules/CN.txt`.
  2) Run `python scripts/update_direct_from_cn.py` to refresh `rules/Direct.list`.
- Update PaoPaoDNS rules:
  1) Run `python scripts/update_dns.py` to refresh `force_ttl_rules.txt`.
- Refresh OpenClash Zashboard on OpenWrt:
  1) Run `sh scripts/update_zashboard.sh` (optional `--install-cron`).

## Validation
- No automated tests.
- Quick checks:
  - YAML syntax/indentation for `mihomo.yaml`.
  - JS syntax for `mihomo.js`.
  - Rule list formatting (one rule per line, no trailing spaces).
  - Placeholder strings remain intact after edits.
